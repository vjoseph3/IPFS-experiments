#!/bin/sh

# This script is referred to as dangerous for two reasons:
#
# 1. It makes changes within the node_modules directory. That is bad
#    for forward compatibility if the dependencies get updated.
#    If the changes are really needed, they should be discussed with
#    the package maintainers.
#
# 2. It enables deterministic generation of secp256k1 private keys,
#    which may have been deliberately avoided by the package creators.
#
#    Q: Why would they avoid it?
#    A: Maybe to keep people from using weak passwords to generate
#       strong-looking cryptographic keys, not realizing that hacking
#       the weak password is enough to then derive the private key.
#       Or maybe they have reasons that I am blissfully ignoring...
#
#    Q: Then why does this script exist?
#    A: This is part of an experiment, NOT TO BE USED IN PRODUCTION CODE.
#       The discoveries from this experiment, if useful, may give rise
#       to productive discussions with package maintainers in the future.
#       In the mean time, this is a good way to get more familiar with
#       the dependencies and what they can do.


# Changes are made so that when the `keyType` property of the argument passed
# to `require("ipfs-core").PeerId.create` is set to "secp256k1", the `bits` property
# of that argument will be used to completely determine the generated keypair.


# check that the package versions have not changed
if [[ "$( cat ./package.json | grep -c "\"ipfs-core\": \"^0.14.2\"" )" == "0" ||
      "$( cat ./package.json | grep -c "\"ipns\": \"^1.0.0\"" )" == "0" ]]; then
  echo "Not customizing node_modules. Dependencies have been updated."
  exit 0
fi

# do nothing if the customizations are already in place
if [[ "$( sed -e '120,121!d' ./node_modules/libp2p-crypto/src/keys/secp256k1-class.js )" ==\
      "  async function generateKeyPair (bits) {
    const privateKeyBytes = bits || await crypto.generateKey()" ]]; then
  exit 0
fi

# make sure the file appears as expected
if [[ "$( sed -e '120,121!d' ./node_modules/libp2p-crypto/src/keys/secp256k1-class.js )" !=\
      "  async function generateKeyPair () {
    const privateKeyBytes = await crypto.generateKey()" ]]; then
  echo "Not customizing node_modules. Target file has been otherwise modified."
  exit 0
fi

# perform the customizations
sed -i .temp.js -e '120s/.*/  async function generateKeyPair (bits) {/'\
  -e '121s/.*/    const privateKeyBytes = bits || await crypto.generateKey()/'\
  ./node_modules/libp2p-crypto/src/keys/secp256k1-class.js
echo "Customized file node_modules/libp2p-crypto/src/keys/secp256k1-class.js"
